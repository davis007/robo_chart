# 株の仮想売買バックテストシステム（厳密版）

yfinanceを使用して株価データを取得し、指定した戦略に基づいて仮想売買を行う厳密なバックテストシステムです。監視銘柄リスト管理機能を搭載。

## 特徴

- yfinanceから株価データ（日足）を自動取得（auto_adjust=Falseで実際のOHLCVを取得）
- SQLiteによるデータキャッシュ機能とキャッシュ整合性チェック
- 戦略カセット方式で様々な売買アルゴリズムを実装可能
- 詳細な売買履歴とパフォーマンス統計を自動出力
- 厳密な日次ログフォーマットと資産曲線の記録
- 最大ドローダウン計算機能
- **監視銘柄リスト管理機能**（銘柄の追加・削除・一覧表示）

## インストール

```bash
# 必要なパッケージをインストール
pip install -r requirements.txt
```

## 使用方法

### 基本的なバックテスト実行方法

```bash
python backtest.py --strategy takazawa --symbol 9984.T --start 2024-01-01 --end 2024-12-31
```

### 監視銘柄リスト管理

```bash
# 監視銘柄リストを表示
python manage.py list

# 銘柄を監視リストに追加
python manage.py add 9984

# 銘柄を監視リストから削除
python manage.py remove 9984.T
```

### 引数の説明

#### backtest.py
- `--strategy`: 戦略名（strategiesフォルダ内のファイル名）
- `--symbol`: 銘柄コード（例: 9984.T, 7203.T, 6758.T）
- `--start`: 開始日（YYYY-MM-DD形式）
- `--end`: 終了日（YYYY-MM-DD形式）

#### manage.py
- `list`: 監視銘柄リストを表示
- `add <symbol>`: 銘柄を監視リストに追加
- `remove <symbol>`: 銘柄を監視リストから削除

### 出力ファイル

- `performance.txt`: バックテスト結果のサマリー
- `datas.sqlite`: 株価データのキャッシュデータベース + 監視銘柄リスト

## 戦略の追加方法

`strategies`フォルダに新しい戦略ファイルを作成します。

### 戦略ファイルのテンプレート（最新版）

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import pandas as pd
from typing import Dict

class Strategy:
    def __init__(self):
        # パラメータの初期化
        pass

    def calculate_signal(self, data: pd.DataFrame, current_date: pd.Timestamp, ctx: Dict) -> Dict:
        """
        売買シグナルを計算

        Args:
            data: 株価データ（DataFrame、当日を含む過去90日分）
            current_date: 現在の日付
            ctx: コンテキスト情報 {
                "position": "LONG" or "FLAT",
                "entry_price": float or None,
                "size": int or 0
            }

        Returns:
            Dict: {'signal': 'BUY'|'SELL'|'HOLD', 'reason': str}
        """
        # ここに売買ロジックを実装
        return {'signal': 'HOLD', 'reason': 'no_signal'}
```

## 利用可能な戦略

### takazawa（高澤式）
- ボリンジャーバンドとRCI（順位相関指数）を使用した売買シグナル生成
- ボリンジャーバンド：下バンド割れで買い、上バンド超えで売り
- RCI：-70以下で買い、70以上で売り
- どちらかの指標がシグナルを出した場合に売買を実行

### sample_ma（グランビルの法則）
- グランビルの法則に基づく移動平均戦略
- 基準EMA（12日）と価格の関係で売買シグナルを生成
- 8つの買いシグナルと4つの売りシグナルを実装
- 損切り機能（3%）と最低保有日数（2日）を設定
- 月間2〜4回のトレードを目指す設計

## 出力例

### 日次ログ出力（performance.txt）
```
=== バックテスト開始 ===
戦略: takazawa
銘柄: 9984.T
期間: 2024-01-01 〜 2024-12-31

2024-01-04 終値=1450 FLAT ポジションなし 累計資産=1000000
2024-01-05 終値=1460 FLAT ポジションなし 累計資産=1000000
2024-01-08 終値=1440 BUY 数量=100 損益=0 累計資産=856000
2024-01-09 終値=1450 HOLD ロング100株保持中 評価損益=+1000 累計資産=857000
2024-01-10 終値=1470 HOLD ロング100株保持中 評価損益=+3000 累計資産=859000
2024-01-11 終値=1490 SELL 数量=100 損益=+5000 累計資産=861000 理由=BB:SELL+RCI:SELL
...

=== バックテスト結果 ===
戦略: takazawa
銘柄: 9984.T
取引回数: 12
勝ちトレード: 8
負けトレード: 4
勝率: 66.7%
総損益: +32000
最終資金: 1032000
最大ドローダウン: -5.2%

=== サマリ ===
総損益: +32000
勝率: 66.7%
取引回数: 12
最大ドローダウン: -5.2%
```

### コンソール出力
```
バックテスト開始: takazawa - 9984.T
期間: 2024-01-01 〜 2024-12-31
yfinanceからデータを取得中: 9984.T (2024-01-01 〜 2024-12-31)
データ取得完了: 245日分

=== バックテスト結果 ===
取引回数: 12
勝ちトレード: 8
負けトレード: 4
勝率: 66.7%
総損益: +32000
最終資金: 1032000
最大ドローダウン: -5.2%

=== サマリ ===
総損益: +32000
勝率: 66.7%
取引回数: 12
最大ドローダウン: -5.2%
```

## 注意事項

- このシステムは教育・研究目的のためのものです
- 実際の投資には使用しないでください
- 株価データはyfinanceから取得するため、利用規約に従ってください
- データの正確性は保証されません
